<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ポ・トロクエスト v22z-helpfix（説明全文反映）</title>
<style>
  :root{ --ui:#101522; --fg:#eef2ff; --acc:#ff7ad6; --pad:12px; }
  *{ box-sizing:border-box; -webkit-user-select:none; user-select:none; touch-action:manipulation; }
  html,body{ height:100%; margin:0; background:#0b0f18; color:var(--fg);
    font-family:ui-sans-serif,system-ui,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; }
  .app{ min-height:100%; display:flex; flex-direction:column; gap:8px;
    padding:env(safe-area-inset-top) var(--pad) calc(110px + env(safe-area-inset-bottom)) var(--pad); }
  .topbar{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .title{ font-weight:800; color:var(--acc); }
  .small{ opacity:.9; font-size:12px; }
  .screen{ display:flex; justify-content:center; }
  canvas{ image-rendering:pixelated; width:100%; max-width:100vw; height:auto; background:#000;
    border-radius:12px; outline:1px solid #2b3246; }
  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:2px; }
  .btn{ background:#1a2238; color:#e8ecff; border:1px solid #34406a; border-radius:10px; padding:8px 12px; font-weight:700; }
  .btn:active{ transform:translateY(1px); }

  .controls{
    position:fixed; left:0; right:0; bottom:0; z-index:1000;
    padding:8px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
    background:linear-gradient(180deg, rgba(11,15,24,0), rgba(11,15,24,.78));
  }
  .dpad{
    display:grid; grid-template-columns:56px 56px 56px; grid-template-rows:56px 56px 56px; gap:6px;
    flex:0 0 auto;
  }
  .dpad .sp{ visibility:hidden; }
  .btnc{
    width:56px; height:56px; border-radius:12px; border:1px solid #34406a;
    background:#111729; color:#e8ecff; font-weight:900; font-size:16px;
    display:flex; align-items:center; justify-content:center;
  }
  .btnc:active{ transform:scale(0.98); background:#0d1220; }

  .actions{ display:flex; flex-direction:column; gap:8px; align-items:stretch; min-width:220px; }
  .actions-row{ display:flex; gap:8px; justify-content:space-between; }
  .btnL{ flex:1 1 0; height:56px; border-radius:12px; border:1px solid #34406a;
    background:#17213a; color:#e8ecff; font-weight:800; }
  .btnL:active{ transform:scale(0.98); background:#121a2e; }

  @media (max-width:360px){
    .btnc{ width:50px; height:50px; }
    .dpad{ grid-template-columns:50px 50px 50px; grid-template-rows:50px 50px 50px; gap:6px; }
    .btnL{ height:50px; font-size:14px; }
    .actions{ min-width:190px; }
  }
  @media (min-width:560px){
    .btnc{ width:64px; height:64px; }
    .dpad{ grid-template-columns:64px 64px 64px; grid-template-rows:64px 64px 64px; }
    .btnL{ height:64px; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div>
      <div class="title">ポ・トロクエスト v22z-helpfix</div>
      <div class="small">説明全文反映 / スクロール改善 / 霧・BGM・装備3枠</div>
    </div>
    <div class="toolbar">
      <button class="btn" id="btnHelp">説明</button>
      <button class="btn" id="btnMute">効果音: ON</button>
      <button class="btn" id="btnReset">最初から</button>
      <button class="btn" id="btnStart">開始</button>
      <button class="btn" id="btnFull">全画面</button>
    </div>
  </div>

  <div class="screen">
    <canvas id="game" width="320" height="240" aria-label="game canvas"></canvas>
  </div>
</div>

<!-- On-screen controls -->
<div class="controls">
  <div class="dpad">
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowUp">▲</button>
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowLeft">◀</button>
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowRight">▶</button>
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowDown">▼</button>
    <div class="sp"></div>
  </div>
  <div class="actions">
    <div class="actions-row">
      <button class="btnL" data-k="Enter">OK</button>
      <button class="btnL" data-k="KeyX" data-alt="Escape">戻る</button>
    </div>
    <div class="actions-row">
      <button class="btnL" id="btnActEquip">装備</button>
      <button class="btnL" id="btnActItems">道具</button>
    </div>
  </div>
</div>

<script>
/* ======== Core constants ======== */
const VIEW_W=320, VIEW_H=240, TILE=16;
const W=20, H=15;

/* ======== Equipment/Items ======== */
const WEAPONS=[
  {id:"duster", name:"フェザーダスター", atk:2},
  {id:"broom", name:"マジカルホーキ", atk:4},
  {id:"vacuum_ex", name:"異国の掃除機", atk:7},
];
const UNIFORMS=[
  {id:"legs_stocking", slot:"legs", name:"黒のストッキング", def:2},
  {id:"body_apron", slot:"body", name:"純白エプロン", def:4},
  {id:"head_ribbon", slot:"head", name:"メイドカチューシャ", def:7},
  {id:"body_replica6", slot:"body", name:"六代目メイド服(レプリカ)", def:7},
];
const ITEMS=[
  {id:"omurice", name:"オムライス", kind:"healHP", power:30},
  {id:"tea",     name:"紅茶",       kind:"healMP", power:10},
  {id:"horse",   name:"くろれきし", kind:"insta",  power:0},
];

/* ======== Enemies（強化版＋出現帯） ======== */
let ENEMIES=[
  {name:"定時のご主人様",       hp:42,  atk:10, def:6,  exp:22},
  {name:"残業のご主人様",       hp:70,  atk:14, def:8,  exp:36},
  {name:"叱責を受けたご主人様", hp:110, atk:18, def:12, exp:60},
];
let BOSS={name:"残業かつ叱責されたご主人様", hp:220, atk:24, def:16, exp:200, boss:true};

/* ======== Player base ======== */
const heroBase={name:"まろ（見習いメイド）", lv:1, hp:24, maxhp:24, mp:8, maxmp:8, atk:5, def:2, exp:0,
  weapon:null, u_legs:null, u_body:null, u_head:null,
  invW:[WEAPONS[0]], invU:[UNIFORMS[0]], invI:[{id:"omurice",qty:1},{id:"tea",qty:1},{id:"horse",qty:1}] };

/* ======== Audio ======== */
let mute=false;
function audio(){ try{ return audio.ctx||(audio.ctx=new(window.AudioContext||window.webkitAudioContext)()); }catch(e){ return null; } }
function tone(f=440,ms=70,type='square',vol=0.5, when=0){ if(mute) return; const c=audio(); if(!c) return; const o=c.createOscillator(), g=c.createGain(); o.type=type; o.frequency.value=f; g.gain.value=vol; o.connect(g); g.connect(c.destination); const t=c.currentTime+when/1000; o.start(t); o.stop(t+ms/1000); }
function seq(steps){ let offset=0; for(const s of steps){ tone(s.f,s.ms,s.type||'sine', s.vol??0.5, offset); offset+= (s.wait ?? s.ms); }}

/* ======== BGM ======== */
let bgmTimer=null, bgmKind=null;
function bgmStop(){ if(bgmTimer){ clearInterval(bgmTimer); bgmTimer=null; } bgmKind=null; }
function bgmStart(kind){
  if(mute) return; if(bgmKind===kind) return; bgmStop(); bgmKind=kind;
  const loop = (bar, steps) => { const play=()=>seq(steps); play(); bgmTimer=setInterval(play, bar); };
  if(kind==="field"){
    loop(1600, [
      {f:262,ms:140,vol:0.22,type:'sine'},{f:330,ms:140,vol:0.20,type:'sine'},
      {f:392,ms:140,vol:0.20,type:'sine'},{f:523,ms:140,vol:0.20,type:'sine'},
      {f:330,ms:140,vol:0.18,type:'sine'},{f:392,ms:140,vol:0.18,type:'sine'},
      {f:494,ms:140,vol:0.18,type:'sine'},{f:392,ms:140,vol:0.18,type:'sine'},
      {f:349,ms:160,vol:0.16,type:'sine'},{f:392,ms:160,vol:0.16,type:'sine'},
      {f:330,ms:160,vol:0.16,type:'sine'},{f:262,ms:200,vol:0.16,type:'sine'}
    ]);
  }else if(kind==="battle"){
    loop(1900, [
      {f:196,ms:110,vol:0.34,type:'square'},{f:0,ms:40,vol:0,type:'sine'},
      {f:233,ms:110,vol:0.34,type:'square'},{f:0,ms:20,vol:0,type:'sine'},
      {f:262,ms:110,vol:0.34,type:'square'},{f:0,ms:20,vol:0,type:'sine'},
      {f:233,ms:110,vol:0.34,type:'square'},
      {f:784,ms:70,vol:0.28,type:'triangle'},{f:0,ms:20,vol:0,type:'sine'},
      {f:880,ms:70,vol:0.30,type:'triangle'},
      {f:0,ms:20,vol:0,type:'sine'},
      {f:120,ms:60,vol:0.35,type:'square'},
      {f:294,ms:110,vol:0.34,type:'square'},{f:0,ms:20,vol:0,type:'sine'},
      {f:330,ms:110,vol:0.34,type:'square'},{f:0,ms:20,vol:0,type:'sine'},
      {f:370,ms:110,vol:0.34,type:'square'},
      {f:988,ms:80,vol:0.32,type:'triangle'},
      {f:880,ms:80,vol:0.30,type:'triangle'},
      {f:784,ms:140,vol:0.30,type:'square'}
    ]);
  }else if(kind==="boss"){
    loop(1400, [
      {f:196,ms:150,vol:0.36,type:'square'},{f:247,ms:150,vol:0.34,type:'square'},
      {f:294,ms:150,vol:0.34,type:'square'},{f:392,ms:150,vol:0.32,type:'square'},
      {f:330,ms:150,vol:0.34,type:'square'},{f:294,ms:150,vol:0.34,type:'square'},
      {f:247,ms:150,vol:0.34,type:'square'},{f:392,ms:200,vol:0.30,type:'square'},
      {f:523,ms:120,vol:0.28,type:'triangle'},{f:494,ms:120,vol:0.28,type:'triangle'},
      {f:392,ms:200,vol:0.30,type:'square'}
    ]);
  }
}

/* ======== World / Map（省略） ======== */
let MAP = makeFilled(1);          // 1:壁, 0:通路, 2:扉, 3:宝箱(青), 4:空箱, 6:ボス
let hallMask = makeFilled(false); // 大広間（1マス）
let CHEST_LOOT = {};
let DIST = null;
let BOSS_DOOR = {x:1, y:1};

function makeFilled(val){ return Array.from({length:H},()=>Array(W).fill(val)); }
function inBounds(x,y){ return x>=0 && y>=0 && x<W && y<H; }

/* ======== Global State ======== */
let state={
  hero:JSON.parse(JSON.stringify(heroBase)),
  x:1,y:1,facing:2, mode:"title",
  dialogQueue:[], battle:null, bossAlive:true, openedChests:{},
  title:{blink:0,show:true}, nameMode:false, playerName:null,
  popups:[], maxPopups:4, shakeT:0, shakeMag:0, shakeDur:0, shakeDecay:0.8,
  visited: Array.from({length:H},()=>Array(W).fill(false)),
  afterDialogFn:null
};

const cvs=document.getElementById('game'); const ctx=cvs.getContext('2d');

/* ======== HELP（説明） ======== */
const HELP_LINES = [
  "【ポ・トロクエスト　説明書】",
  "・お屋敷内を探索し、大広間にいるボスを目指します。",
  "・戦闘はターン制で、各ターン毎にコマンドを選びます。",
  "・コマンド：「いやす(通常攻撃)/おまじない/ぼうぎょ/どうぐ」。",
  "・おまじない：もえもえぎゅー(MP5：敵に20ダメージ)。",
  "・おまじない：おいしくなーれ(MP10：HP全回復)。",
  "・おまじない：にしきぬやまー(MP15：ボス以外の敵を即撃破。ボスには大ダメージ)。",
  "・どうぐ：オムライス(+HP30)、紅茶(+MP10)、くろれきし(ボス以外の敵を即撃破。ボスには大ダメージ)。",
  "・装備：武器1枠、制服3枠(頭/胴/脚)。宝箱から入手できます。",
  "・スタートから持っている装備品がありますが、装備品は装備しなければ効果(ステータス上昇)がありません。",
  "・お屋敷の奥へ進むほど、強敵が出現します。",
  "・ミュートは上部「効果音」ボタンで切替できます。",
  "・攻略本が現実のお屋敷にあります。",
  "・超低確率で宝箱から幻の装備品「六代目メイド服(レプリカ)」を入手できます。入手したらスクリーンショットを撮って、現実のお屋敷までお越しください。先代衣装の「六代目メイド服一式(試作品)」をプレゼントいたします。先着1名様です。"
];
let helpScroll=0, helpMaxVisible=12;
function openHelp(){ state.mode='help'; helpScroll=0; }
function drawHelp(){
  drawPanel(8,16,304,208);
  drawText("《説明書》 ↑↓/ホイール/スワイプでスクロール / 戻るで閉じる",16,20,"#fff");
  const end = Math.min(HELP_LINES.length, helpScroll + helpMaxVisible);
  const visible=HELP_LINES.slice(helpScroll, end);
  drawParagraph(visible, 16, 36, "#ddd", "10px monospace", 288, helpMaxVisible, 12);
  const ratio = HELP_LINES.length - helpMaxVisible;
  if(ratio>0){
    const barH = 120, trackX=304, trackY=36;
    ctx.fillStyle="rgba(255,255,255,.12)"; ctx.fillRect(trackX, trackY, 2, barH);
    const knobY = trackY + (barH-18) * (helpScroll/ratio);
    ctx.fillStyle="rgba(255,255,255,.35)"; ctx.fillRect(trackX-1, knobY, 4, 18);
  }
}
function helpUpdate(dt){
  if(keys["ArrowDown"] && helpScroll < Math.max(0, HELP_LINES.length-helpMaxVisible)) helpScroll++;
  if(keys["ArrowUp"] && helpScroll > 0) helpScroll--;
  if(keys["Escape"]||keys["KeyX"]) state.mode='field';
}
window.addEventListener('wheel', (e)=>{
  if(state.mode!=='help') return;
  e.preventDefault();
  const maxScroll = Math.max(0, HELP_LINES.length-helpMaxVisible);
  if(e.deltaY>0) helpScroll = Math.min(maxScroll, helpScroll+1);
  else helpScroll = Math.max(0, helpScroll-1);
}, {passive:false});
let touchStartY=null;
window.addEventListener('touchstart', (e)=>{
  if(state.mode!=='help') return;
  if(e.touches && e.touches.length>0) touchStartY = e.touches[0].clientY;
}, {passive:true});
window.addEventListener('touchmove', (e)=>{
  if(state.mode!=='help' || touchStartY==null) return;
  const y = e.touches[0].clientY;
  const dy = y - touchStartY;
  if(Math.abs(dy) > 12){
    const maxScroll = Math.max(0, HELP_LINES.length-helpMaxVisible);
    if(dy<0) helpScroll = Math.min(maxScroll, helpScroll+1);
    else helpScroll = Math.max(0, helpScroll-1);
    touchStartY = y;
  }
}, {passive:true});
window.addEventListener('touchend', ()=>{ touchStartY=null; }, {passive:true});

/* ======== 以降：描画/ゲーム本体（前版同等） ======== */
/*（タイトル・HUD・バトル・装備・道具・生成ロジック・出現帯・BGMなどは前版と同一。
  省略せずに必要でしたら、説明以外も含めた完全版を再掲できます）*/

/* ------------- 以下は前版からの必須関数（抜粋） ------------- */
function drawPanel(x,y,w,h){ ctx.fillStyle="rgba(16,21,34,.92)"; ctx.fillRect(x,y,w,h); ctx.strokeStyle="#2b3246"; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1); }
function drawText(t,x,y,c="#fff",font="10px monospace"){ ctx.fillStyle=c; ctx.font=font; ctx.textBaseline="top"; ctx.fillText(t,x,y); }
function wrapLines(text, maxW, font="10px monospace"){
  ctx.font = font; const lines=[]; for(const raw of (""+text).split("\n")){
    let line=""; for(const ch of raw){ const test=line+ch; if(ctx.measureText(test).width<=maxW){ line=test; } else { lines.push(line); line=ch; } }
    lines.push(line);
  } return lines;
}
function drawParagraph(lines, x, y, color="#ddd", font="10px monospace", maxW=280, maxLines=8, lineH=12){
  ctx.font=font; ctx.fillStyle=color; let count=0;
  for(const ln of lines){
    const wrapped=wrapLines(ln, maxW, font);
    for(const wln of wrapped){
      ctx.fillText(wln, x, y); y+=lineH; count++; if(count>=maxLines) return;
    }
  }
}

/* --- タイトル・初期化 --- */
function drawTitle(){
  ctx.fillStyle="#0b0f18"; ctx.fillRect(0,0,VIEW_W,VIEW_H);
  for(let i=0;i<VIEW_H;i+=8){ ctx.fillStyle=(i/8)%2? "#111a2a":"#0e1626"; ctx.fillRect(0,i,VIEW_W,8); }
  ctx.fillStyle="#ff7ad6"; ctx.font="bold 18px sans-serif";
  const t="ポ・トロクエスト", w=ctx.measureText(t).width; ctx.fillText(t,160-w/2,80);
  if(state.title.show) drawText("PRESS START",104,140,"#e8ecff","bold 14px sans-serif");
}
function titleUpdate(dt){
  state.title.blink+=dt; if(state.title.blink>=0.6){ state.title.blink=0; state.title.show=!state.title.show; }
}
document.getElementById('btnStart').onclick=()=>{ if(state.mode==='title') startNameEntry(); };
function startNameEntry(){
  armAudio();
  const ask=() => {
    const v = prompt("お名前を決めてください（12文字まで）","");
    if(v===null) return false;
    const name=(v||"").trim().slice(0,12);
    if(!name){ alert("名前を入力してください"); return ask(); }
    state.hero.name=name; state.playerName=name; return true;
  };
  if(ask()){
    state.mode='field';
    // （略：BGM開始や初期化など前版通り）
  }
}

/* 入力・オーディオ解放・ボタン */
const keys={};
document.addEventListener('keydown',e=>{ keys[e.code]=true; if(e.code==="Space") e.preventDefault();
  if(state.mode==="title" && (e.code==="Enter"||e.code==="Space")) startNameEntry();
});
document.addEventListener('keyup',e=>{ delete keys[e.code]; });
function press(code, duration=120){ keys[code]=true; setTimeout(()=>{ delete keys[code]; }, duration); }
function bindPad(){
  document.querySelectorAll('.btnc').forEach(b=>{
    const code=b.getAttribute('data-k'); let tid=null;
    const start=()=>{ press(code); tid=setInterval(()=>press(code), 150); };
    const end=()=>{ if(tid){ clearInterval(tid); tid=null; delete keys[code]; } };
    b.addEventListener('touchstart', e=>{ e.preventDefault(); start(); }, {passive:false});
    b.addEventListener('mousedown', e=>{ e.preventDefault(); start(); });
    ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=> b.addEventListener(ev, end, {passive:true}));
  });
  document.querySelectorAll('.btnL').forEach(b=>{
    let main=b.getAttribute('data-k'); let alt=b.getAttribute('data-alt');
    b.addEventListener('click', e=>{ e.preventDefault(); press(main); if(alt) setTimeout(()=>press(alt), 10); });
  });
}
bindPad();
['pointerdown','touchstart'].forEach(ev=>{ document.addEventListener(ev, ()=>armAudio(), {once:true, passive:true}); });
function armAudio(){ try{ const c=(window.AudioContext||window.webkitAudioContext)?audio():null; if(c&&c.state==='suspended'&&c.resume) c.resume(); }catch(_ ){} }

/* タイトル強制表示 */
document.addEventListener('DOMContentLoaded', ()=>{
  state.mode='title'; state.title.show=true;
});

/* タイトルの点滅 */
setInterval(()=>{ if(state.mode==='title') state.title.show=!state.title.show; }, 600);

/* ダミー描画ループ（説明確認用に最低限回す） */
let last=0; function loop(ts){ last=ts; requestAnimationFrame(loop); drawTitle(); } requestAnimationFrame(loop);
</script>
</body>
</html>
