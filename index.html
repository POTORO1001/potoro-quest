<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ポ・トロクエスト v21（iPhone縦UI）</title>
<style>
  :root{ --ui:#101522; --fg:#eef2ff; --acc:#ff7ad6; --pad:12px; }
  *{ box-sizing:border-box; -webkit-user-select:none; user-select:none; touch-action:manipulation; }
  html,body{ height:100%; margin:0; background:#0b0f18; color:var(--fg);
    font-family:ui-sans-serif,system-ui,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; }
  .app{ min-height:100%; display:flex; flex-direction:column; gap:8px;
    padding:env(safe-area-inset-top) var(--pad) calc(96px + env(safe-area-inset-bottom)) var(--pad); }
  .topbar{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .title{ font-weight:800; color:var(--acc); }
  .small{ opacity:.9; font-size:12px; }
  .screen{ display:flex; justify-content:center; }
  canvas{ image-rendering:pixelated; width:100%; max-width:100vw; height:auto; background:#000;
    border-radius:12px; outline:1px solid #2b3246; }
  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:2px; }
  .btn{ background:#1a2238; color:#e8ecff; border:1px solid #34406a; border-radius:10px; padding:8px 12px; font-weight:700; }
  .btn:active{ transform:translateY(1px); }
  /* On-screen controls */
  .controls{ position:fixed; left:0; right:0; bottom:0;
    padding:8px env(safe-area-inset-right) calc(8px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    display:flex; align-items:flex-end; justify-content:space-between; gap:8px;
    background:linear-gradient(180deg, rgba(11,15,24,0), rgba(11,15,24,.75)); }
  .dpad{ display:grid; grid-template-columns:56px 56px 56px; grid-template-rows:56px 56px 56px; gap:6px; }
  .dpad .sp{ visibility:hidden; }
  .btnc{ width:56px; height:56px; border-radius:12px; border:1px solid #34406a; background:#111729; color:#e8ecff;
    font-weight:900; font-size:16px; display:flex; align-items:center; justify-content:center; }
  .btnc:active{ transform:scale(0.98); background:#0d1220; }
  .actions{ display:grid; grid-template-columns:repeat(3,88px); gap:6px; align-items:end; }
  .btnL{ width:88px; height:56px; border-radius:12px; border:1px solid #34406a; background:#17213a; color:#e8ecff; font-weight:800; }
  .btnL:active{ transform:scale(0.98); background:#121a2e; }
  @media (min-width:560px){
    .actions{ grid-template-columns:repeat(3,110px); }
    .btnL{ height:64px; }
    .btnc{ width:64px; height:64px; }
    .dpad{ grid-template-columns:64px 64px 64px; grid-template-rows:64px 64px 64px; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div>
      <div class="title">ポ・トロクエスト v21</div>
      <div class="small">iPhone縦レイアウト：フルマップ表示＋仮想ボタン（タップ対応）</div>
    </div>
    <div class="toolbar">
      <button class="btn" id="btnEquip">装備</button>
      <button class="btn" id="btnMute">効果音: ON</button>
      <button class="btn" id="btnReset">最初から</button>
      <button class="btn" id="btnStart">開始</button>
      <button class="btn" id="btnFull">全画面</button>
    </div>
  </div>

  <div class="screen">
    <canvas id="game" width="320" height="240" aria-label="game canvas"></canvas>
  </div>
</div>

<!-- On-screen controls -->
<div class="controls">
  <div class="dpad">
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowUp">▲</button>
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowLeft">◀</button>
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowRight">▶</button>
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowDown">▼</button>
    <div class="sp"></div>
  </div>
  <div class="actions">
    <button class="btnL" data-k="Enter">OK</button>
    <button class="btnL" data-k="KeyX" data-alt="Escape">戻る</button>
    <button class="btnL" id="btnActEquip">装備</button>
  </div>
</div>

<script>
/* ======== Core data & state ======== */
const VIEW_W=320, VIEW_H=240, TILE=16;
const MAP=[
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
 [1,0,0,0,1,0,0,0,0,0,1,0,3,0,0,0,1,0,0,1],
 [1,0,1,0,1,0,1,1,1,0,1,0,1,1,1,0,1,0,0,1],
 [1,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,1,0,1],
 [1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,0,1,0,1],
 [1,0,0,0,0,1,0,0,0,0,3,1,0,0,0,0,0,1,0,1],
 [1,1,1,1,0,1,1,1,1,0,1,1,1,1,0,1,0,1,0,1],
 [1,0,0,1,0,0,0,0,1,0,0,0,0,1,0,1,0,1,0,1],
 [1,0,1,1,1,1,1,0,1,1,1,1,0,1,0,1,0,1,0,1],
 [1,0,0,0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,0,1],
 [1,0,1,1,1,0,1,1,1,1,0,1,0,1,1,1,1,1,0,1],
 [1,0,0,0,1,0,0,0,3,1,0,0,0,0,0,0,0,1,2,1],
 [1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,0,1,6,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,3,1],
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
];
// 0:木目通路 / 1:壁(緑) / 2:重扉 / 3:宝箱 / 4:空箱 / 6:ボス

const WEAPONS=[
  {id:"duster", name:"フェザーダスター", atk:2},
  {id:"broom", name:"マジカルホーキ", atk:4},
  {id:"vacuum_ex", name:"異国の掃除機", atk:7},
];
const UNIFORMS=[
  {id:"legs_stocking", slot:"legs", name:"黒のストッキング", def:2},
  {id:"body_apron", slot:"body", name:"純白エプロン", def:4},
  {id:"head_ribbon", slot:"head", name:"メイドカチューシャ", def:7},
  {id:"body_replica6", slot:"body", name:"六代目メイド服(レプリカ)", def:7}, // レア(宝箱のみ/1/500)
];
const ITEMS=[
  {id:"omurice", name:"オムライス", kind:"healHP", power:20},
  {id:"tea", name:"紅茶", kind:"healMP", power:10},
  {id:"horse", name:"くろれきし", kind:"insta", power:0}, // 旧おうまさん
];

const heroBase={name:"まろ（見習いメイド）", lv:1, hp:24, maxhp:24, mp:8, maxmp:8, atk:5, def:2, exp:0,
  weapon:null, u_legs:null, u_body:null, u_head:null,
  invW:[WEAPONS[0]], invU:[UNIFORMS[0]], invI:[{id:"omurice",qty:1},{id:"tea",qty:1},{id:"horse",qty:1}] };

let ENEMIES=[
  {name:"定時のご主人様", hp:18, atk:4,
