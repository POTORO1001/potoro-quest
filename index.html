<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ãƒãƒ»ãƒˆãƒ­ã‚¯ã‚¨ã‚¹ãƒˆ v22c-bgmï¼ˆiPhoneç¸¦UI + BGMé€šå¸¸/ãƒœã‚¹ + ãƒ•ã‚©ã‚°ï¼‰</title>
<style>
  :root{ --ui:#101522; --fg:#eef2ff; --acc:#ff7ad6; --pad:12px; }
  *{ box-sizing:border-box; -webkit-user-select:none; user-select:none; touch-action:manipulation; }
  html,body{ height:100%; margin:0; background:#0b0f18; color:var(--fg);
    font-family:ui-sans-serif,system-ui,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; }
  .app{ min-height:100%; display:flex; flex-direction:column; gap:8px;
    padding:env(safe-area-inset-top) var(--pad) calc(110px + env(safe-area-inset-bottom)) var(--pad); }
  .topbar{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .title{ font-weight:800; color:var(--acc); }
  .small{ opacity:.9; font-size:12px; }
  .screen{ display:flex; justify-content:center; }
  canvas{ image-rendering:pixelated; width:100%; max-width:100vw; height:auto; background:#000;
    border-radius:12px; outline:1px solid #2b3246; }
  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:2px; }
  .btn{ background:#1a2238; color:#e8ecff; border:1px solid #34406a; border-radius:10px; padding:8px 12px; font-weight:700; }
  .btn:active{ transform:translateY(1px); }

  /* --- å†æ§‹ç¯‰: ä¸‹éƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒå¸¸ã«è¦‹ãˆã‚‹ --- */
  .controls{
    position:fixed; left:0; right:0; bottom:0;
    z-index:1000;
    padding:8px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
    background:linear-gradient(180deg, rgba(11,15,24,0), rgba(11,15,24,.78));
  }
  .dpad{
    display:grid; grid-template-columns:56px 56px 56px; grid-template-rows:56px 56px 56px; gap:6px;
    flex:0 0 auto;
  }
  .dpad .sp{ visibility:hidden; }
  .btnc{
    width:56px; height:56px; border-radius:12px; border:1px solid #34406a;
    background:#111729; color:#e8ecff; font-weight:900; font-size:16px;
    display:flex; align-items:center; justify-content:center;
  }
  .btnc:active{ transform:scale(0.98); background:#0d1220; }

  /* å³å´ã¯ç¸¦2æ®µï¼ˆä¸Šï¼šOK/æˆ»ã‚‹ã€ä¸‹ï¼šè£…å‚™ï¼‰*/
  .actions{
    display:flex; flex-direction:column; gap:8px; align-items:stretch;
    min-width: 200px;
  }
  .actions-row{ display:flex; gap:8px; justify-content:space-between; }
  .btnL{
    flex:1 1 0;
    height:56px; border-radius:12px; border:1px solid #34406a;
    background:#17213a; color:#e8ecff; font-weight:800;
  }
  .btnL:active{ transform:scale(0.98); background:#121a2e; }

  @media (max-width:360px){
    .btnc{ width:50px; height:50px; }
    .dpad{ grid-template-columns:50px 50px 50px; grid-template-rows:50px 50px 50px; gap:6px; }
    .btnL{ height:50px; font-size:14px; }
    .actions{ min-width: 180px; }
  }
  @media (min-width:560px){
    .btnc{ width:64px; height:64px; }
    .dpad{ grid-template-columns:64px 64px 64px; grid-template-rows:64px 64px 64px; }
    .btnL{ height:64px; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div>
      <div class="title">ãƒãƒ»ãƒˆãƒ­ã‚¯ã‚¨ã‚¹ãƒˆ v22c-bgm</div>
      <div class="small">iPhoneç¸¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šãƒ•ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºï¼‹ä»®æƒ³ãƒœã‚¿ãƒ³ï¼ˆã‚¿ãƒƒãƒ—å¯¾å¿œï¼‰ / BGMï¼ˆé€šå¸¸/ãƒœã‚¹ï¼‰ / ãƒ•ã‚©ã‚°</div>
    </div>
    <div class="toolbar">
      <button class="btn" id="btnEquip">è£…å‚™</button>
      <button class="btn" id="btnMute">åŠ¹æœéŸ³: ON</button>
      <button class="btn" id="btnReset">æœ€åˆã‹ã‚‰</button>
      <button class="btn" id="btnStart">é–‹å§‹</button>
      <button class="btn" id="btnFull">å…¨ç”»é¢</button>
    </div>
  </div>

  <div class="screen">
    <canvas id="game" width="320" height="240" aria-label="game canvas"></canvas>
  </div>
</div>

<!-- On-screen controls -->
<div class="controls">
  <div class="dpad">
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowUp">â–²</button>
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowLeft">â—€</button>
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowRight">â–¶</button>
    <div class="sp"></div>
    <button class="btnc" data-k="ArrowDown">â–¼</button>
    <div class="sp"></div>
  </div>

  <div class="actions">
    <div class="actions-row">
      <button class="btnL" data-k="Enter">OK</button>
      <button class="btnL" data-k="KeyX" data-alt="Escape">æˆ»ã‚‹</button>
    </div>
    <div class="actions-row">
      <button class="btnL" id="btnActEquip">è£…å‚™</button>
    </div>
  </div>
</div>

<script>
/* ======== Core data & state ======== */
const VIEW_W=320, VIEW_H=240, TILE=16;
const MAP=[
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
 [1,0,0,0,1,0,0,0,0,0,1,0,3,0,0,0,1,0,0,1],
 [1,0,1,0,1,0,1,1,1,0,1,0,1,1,1,0,1,0,0,1],
 [1,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,1,0,1],
 [1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,0,1,0,1],
 [1,0,0,0,0,1,0,0,0,0,3,1,0,0,0,0,0,1,0,1],
 [1,1,1,1,0,1,1,1,1,0,1,1,1,1,0,1,0,1,0,1],
 [1,0,0,1,0,0,0,0,1,0,0,0,0,1,0,1,0,1,0,1],
 [1,0,1,1,1,1,1,0,1,1,1,1,0,1,0,1,0,1,0,1],
 [1,0,0,0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,0,1],
 [1,0,1,1,1,0,1,1,1,1,0,1,0,1,1,1,1,1,0,1],
 [1,0,0,0,1,0,0,0,3,1,0,0,0,0,0,0,0,1,2,1],
 [1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,0,1,6,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,3,1],
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
];
// 0:æœ¨ç›®é€šè·¯ / 1:å£(ç·‘) / 2:é‡æ‰‰ / 3:å®ç®± / 4:ç©ºç®± / 6:ãƒœã‚¹

const WEAPONS=[
  {id:"duster", name:"ãƒ•ã‚§ã‚¶ãƒ¼ãƒ€ã‚¹ã‚¿ãƒ¼", atk:2},
  {id:"broom", name:"ãƒã‚¸ã‚«ãƒ«ãƒ›ãƒ¼ã‚­", atk:4},
  {id:"vacuum_ex", name:"ç•°å›½ã®æƒé™¤æ©Ÿ", atk:7},
];
const UNIFORMS=[
  {id:"legs_stocking", slot:"legs", name:"é»’ã®ã‚¹ãƒˆãƒƒã‚­ãƒ³ã‚°", def:2},
  {id:"body_apron", slot:"body", name:"ç´”ç™½ã‚¨ãƒ—ãƒ­ãƒ³", def:4},
  {id:"head_ribbon", slot:"head", name:"ãƒ¡ã‚¤ãƒ‰ã‚«ãƒãƒ¥ãƒ¼ã‚·ãƒ£", def:7},
  {id:"body_replica6", slot:"body", name:"å…­ä»£ç›®ãƒ¡ã‚¤ãƒ‰æœ(ãƒ¬ãƒ—ãƒªã‚«)", def:7}, // ãƒ¬ã‚¢(å®ç®±ã®ã¿/1/500)
];
const ITEMS=[
  {id:"omurice", name:"ã‚ªãƒ ãƒ©ã‚¤ã‚¹", kind:"healHP", power:20},
  {id:"tea", name:"ç´…èŒ¶", kind:"healMP", power:10},
  {id:"horse", name:"ãã‚ã‚Œãã—", kind:"insta", power:0}, // æ—§ãŠã†ã¾ã•ã‚“
];

const heroBase={name:"ã¾ã‚ï¼ˆè¦‹ç¿’ã„ãƒ¡ã‚¤ãƒ‰ï¼‰", lv:1, hp:24, maxhp:24, mp:8, maxmp:8, atk:5, def:2, exp:0,
  weapon:null, u_legs:null, u_body:null, u_head:null,
  invW:[WEAPONS[0]], invU:[UNIFORMS[0]], invI:[{id:"omurice",qty:1},{id:"tea",qty:1},{id:"horse",qty:1}] };

let ENEMIES=[
  {name:"å®šæ™‚ã®ã”ä¸»äººæ§˜", hp:18, atk:4, def:1, exp:9},
  {name:"æ®‹æ¥­ã®ã”ä¸»äººæ§˜", hp:24, atk:6, def:2, exp:14},
  {name:"å±è²¬ã‚’å—ã‘ãŸã”ä¸»äººæ§˜", hp:28, atk:7, def:2, exp:18},
];
let BOSS={name:"æ®‹æ¥­ã‹ã¤å±è²¬ã•ã‚ŒãŸã”ä¸»äººæ§˜", hp:60, atk:9, def:3, exp:55, boss:true};

const CHEST_LOOT={
  "12,1": {type:"weapon", item:WEAPONS[1]},
  "10,5": {type:"uniform", item:UNIFORMS[1]},
  "8,11":  {type:"uniform", item:UNIFORMS[2]},
  "18,13": {type:"weapon", item:WEAPONS[2]},
};

// ---------- Audio ----------
let mute=false;
function audio(){ try{ return audio.ctx||(audio.ctx=new(window.AudioContext||window.webkitAudioContext)()); }catch(e){ return null; } }
function tone(f=440,ms=70,type='square',vol=0.5, when=0){ if(mute) return; const c=audio(); if(!c) return; const o=c.createOscillator(), g=c.createGain(); o.type=type; o.frequency.value=f; g.gain.value=vol; o.connect(g); g.connect(c.destination); const t=c.currentTime+when/1000; o.start(t); o.stop(t+ms/1000); }
function seq(steps){ let offset=0; for(const s of steps){ tone(s.f,s.ms,s.type||'sine', s.vol??0.5, offset); offset+= (s.wait ?? s.ms); }}

// ---- BGMï¼ˆç°¡æ˜“ãƒ«ãƒ¼ãƒ‘ãƒ¼ãƒ»é€šå¸¸/ãƒœã‚¹åˆ‡æ›¿ï¼‰----
let bgmTimer=null, bgmKind=null;
function bgmStop(){ if(bgmTimer){ clearInterval(bgmTimer); bgmTimer=null; } bgmKind=null; }
function bgmStart(kind){
  if(mute) return;
  if(bgmKind===kind) return;
  bgmStop();
  bgmKind=kind;

  const loop = (bar, steps) => { const play=()=>seq(steps); play(); bgmTimer=setInterval(play, bar); };

  if(kind==="field"){
    // ç©ã‚„ã‹ãƒ»åˆ†æ•£å’ŒéŸ³
    loop(1600, [
      {f:262,ms:140,vol:0.22,type:'sine'},{f:330,ms:140,vol:0.20,type:'sine'},
      {f:392,ms:140,vol:0.20,type:'sine'},{f:523,ms:140,vol:0.20,type:'sine'},
      {f:330,ms:140,vol:0.18,type:'sine'},{f:392,ms:140,vol:0.18,type:'sine'},
      {f:494,ms:140,vol:0.18,type:'sine'},{f:392,ms:140,vol:0.18,type:'sine'},
      {f:349,ms:160,vol:0.16,type:'sine'},{f:392,ms:160,vol:0.16,type:'sine'},
      {f:330,ms:160,vol:0.16,type:'sine'},{f:262,ms:200,vol:0.16,type:'sine'}
    ]);
  }else if(kind==="battle"){
    // é€šå¸¸æˆ¦é—˜ï¼šè»½å¿«ãƒ»çŸ­éŸ³ã‚¹ã‚¿ãƒƒã‚«ãƒ¼ãƒˆ
    loop(1200, [
      {f:440,ms:90,vol:0.30,type:'square'},{f:494,ms:90,vol:0.30,type:'square'},
      {f:523,ms:90,vol:0.30,type:'square'},{f:587,ms:90,vol:0.28,type:'square'},
      {f:494,ms:90,vol:0.30,type:'square'},{f:440,ms:90,vol:0.30,type:'square'},
      {f:392,ms:90,vol:0.30,type:'square'},{f:349,ms:180,vol:0.28,type:'square'}
    ]);
  }else if(kind==="boss"){
    // ãƒœã‚¹æˆ¦é—˜å°‚ç”¨ï¼šé‡ã‚ãƒ»ä½éŸ³å¼·èª¿
    loop(1400, [
      {f:196,ms:150,vol:0.36,type:'square'},{f:247,ms:150,vol:0.34,type:'square'},
      {f:294,ms:150,vol:0.34,type:'square'},{f:392,ms:150,vol:0.32,type:'square'},
      {f:330,ms:150,vol:0.34,type:'square'},{f:294,ms:150,vol:0.34,type:'square'},
      {f:247,ms:150,vol:0.34,type:'square'},{f:392,ms:200,vol:0.30,type:'square'},
      {f:523,ms:120,vol:0.28,type:'triangle'},{f:494,ms:120,vol:0.28,type:'triangle'},
      {f:392,ms:200,vol:0.30,type:'square'}
    ]);
  }
}

// ---------- Global State ----------
let state={ hero:JSON.parse(JSON.stringify(heroBase)), x:1,y:1,facing:2, mode:"title",
  dialogQueue:[], battle:null, bossAlive:true, openedChests:{}, title:{blink:0,show:true}, nameMode:false, playerName:null,
  popups:[], maxPopups:4, shakeT:0, shakeMag:0, shakeDur:0, shakeDecay:0.8,
  visited: Array.from({length:15},()=>Array(20).fill(false)) // ãƒ•ã‚©ã‚°ç”¨
};

const cvs=document.getElementById('game'); const ctx=cvs.getContext('2d');

// ---------- Rendering ----------
function draw(){
  ctx.save();
  if(state.shakeT>0){
    const ratio = state.shakeT / state.shakeDur;
    const s = state.shakeMag * ratio;
    const dx = (Math.random()*2-1)*s;
    const dy = (Math.random()*2-1)*s;
    ctx.translate(dx,dy);
  }
  if(state.mode==="title") { drawTitle(); ctx.restore(); return; }

  // map
  for(let j=0;j<15;j++){ for(let i=0;i<20;i++){
    let t=MAP[j][i]; if(t===3 && state.openedChests[i+","+j]) t=4;
    if(MAP[j][i]===0) drawWood(i*16,j*16,16,16);
    else { ctx.fillStyle="#1f3b2d"; ctx.fillRect(i*16,j*16,16,16); ctx.fillStyle="#28543d"; for(let k=0;k<16;k+=4) ctx.fillRect(i*16, j*16+k, 16, 1); }
  }}

  // objects
  for(let j=0;j<15;j++){ for(let i=0;i<20;i++){
    const t=MAP[j][i];
    if(t===3 || (t===4 && !state.openedChests[i+","+j])){ ctx.fillStyle="#b48a3c"; ctx.fillRect(i*16+3,j*16+5,10,8); ctx.fillStyle="#6d5b2c"; ctx.fillRect(i*16+3,j*16+9,10,1); }
    else if(t===4 && state.openedChests[i+","+j]){ ctx.fillStyle="#6d5b2c"; ctx.fillRect(i*16+3,j*16+9,10,4); ctx.fillStyle="#b48a3c"; ctx.fillRect(i*16+3,j*16+5,10,3); }
    else if(t===2){ ctx.fillStyle="#264a36"; ctx.fillRect(i*16+2,j*16+2,12,12); }
    else if(t===6){ ctx.fillStyle="#3fa36b"; ctx.fillRect(i*16+4,j*16+4,8,8); }
  }}

  drawText("ç„é–¢ãƒ›ãƒ¼ãƒ«",18,4,"#a4e0b0"); drawText("å¤§åºƒé–“",256,212,"#7ad39f");
  drawMaid(state.x,state.y,state.facing); drawHUD();

  // Fog of War overlayï¼ˆæœªè¸ç ´ã‚’æš—ãï¼‰
  drawFog();

  if(state.mode==="dialog") drawDialog(); else if(state.mode==="battle") drawBattle(); else if(state.mode==="equip") drawEquip();
  drawPopups();
  ctx.restore();
}

function drawWood(x,y,w,h){ ctx.fillStyle="#8a6b3a"; ctx.fillRect(x,y,w,h); ctx.fillStyle="#b48a3c"; for(let k=2;k<h;k+=4) ctx.fillRect(x, y+k, w, 1); ctx.fillStyle="#7a5f33"; for(let k=3;k<w;k+=6) ctx.fillRect(x+k, y+1, 1, h-2); }

function drawTitle(){
  // ç”»åƒç„¡ã—ã§ã‚‚å¿…ãšã‚¿ã‚¤ãƒˆãƒ«ãŒå‡ºã‚‹å®‰å…¨æç”»
  ctx.fillStyle="#0b0f18"; ctx.fillRect(0,0,320,240);
  for(let i=0;i<240;i+=8){ ctx.fillStyle=(i/8)%2? "#111a2a":"#0e1626"; ctx.fillRect(0,i,320,8); }
  drawTitleText("ãƒãƒ»ãƒˆãƒ­ã‚¯ã‚¨ã‚¹ãƒˆ",160,80);
  if(state.title.show) drawText("PRESS START",104,140,"#e8ecff","bold 14px sans-serif");
}

function drawTitleText(t,cx,y){ ctx.fillStyle="#ff7ad6"; ctx.font="bold 18px sans-serif"; ctx.textBaseline="top"; const w=ctx.measureText(t).width; ctx.fillText(t,cx-w/2,y); }
function drawText(t,x,y,c="#fff",font="10px monospace"){ ctx.fillStyle=c; ctx.font=font; ctx.textBaseline="top"; ctx.fillText(t,x,y); }

function drawMaid(tx,ty,dir){
  const x=tx*16,y=ty*16,h=state.hero;
  ctx.fillStyle="#6b3f2a"; ctx.fillRect(x+5,y+2,6,4);         // é«ª
  ctx.fillStyle="#ffecd6"; ctx.fillRect(x+6,y+5,4,4);         // é¡”
  ctx.fillStyle="#ffd6f2"; ctx.fillRect(x+5,y+9,6,7);         // æœ
  if(h.u_body){ ctx.fillStyle="#ffffff"; ctx.fillRect(x+6,y+10,4,4); } // ã‚¨ãƒ—ãƒ­ãƒ³
  const legsCol=h.u_legs?"#2b2b3a":"#222";
  ctx.fillStyle=legsCol; ctx.fillRect(x+5,y+16,2,2); ctx.fillRect(x+9,y+16,2,2); // è¶³
  if(h.u_head){ ctx.fillStyle="#ff9ad6"; ctx.fillRect(x+7,y+1,2,2); }   // ã‚«ãƒãƒ¥ãƒ¼ã‚·ãƒ£
  if(dir===1){ ctx.fillStyle="#ff9ad6"; ctx.fillRect(x+11,y+7,2,2); }
  if(dir===3){ ctx.fillStyle="#ff9ad6"; ctx.fillRect(x+3,y+7,2,2); }
}

function drawPanel(x,y,w,h){ ctx.fillStyle="rgba(16,21,34,.92)"; ctx.fillRect(x,y,w,h); ctx.strokeStyle="#2b3246"; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1); }
function totalDef(h){ return h.def + (h.u_legs?h.u_legs.def:0) + (h.u_body?h.u_body.def:0) + (h.u_head?h.u_head.def:0); }
function drawHUD(){
  ctx.fillStyle="rgba(0,0,0,.55)"; ctx.fillRect(0,0,320,18);
  const h=state.hero; const atk=h.atk+(h.weapon?h.weapon.atk:0), def=totalDef(h);
  drawText(`${h.name}  LV:${h.lv}  HP:${h.hp}/${h.maxhp}  MP:${h.mp}/${h.maxmp}  ATK:${atk}  DEF:${def}`,4,4,"#fff");
}

function drawDialog(){ const lines=state.dialogQueue.length?state.dialogQueue[0].split("\n"):["..."]; drawPanel(8,160,304,72); for(let i=0;i<lines.length;i++) drawText(lines[i],14,166+i*12); drawText("â–¼ ã‚¿ãƒƒãƒ—/OKã§é€²ã‚€",184,222,"#a4b0ff"); }

function drawBattle(){
  const b=state.battle,h=state.hero,e=b.enemy; drawPanel(8,20,304,208);
  drawText("ã€Šæˆ¦é—˜ã€‹",16,24,"#fff");
  drawText(`${e.name}`,16,40,"#ffd37a"); // â˜… æ•µHPã¯éè¡¨ç¤º
  drawText(`${h.name}  HP:${h.hp}/${h.maxhp} MP:${h.mp}/${h.maxmp}`,144,40,"#7ad3ff");
  let y=56; for(let i=Math.max(0,b.log.length-6); i<b.log.length; i++){ drawText(b.log[i],16,y,"#ddd"); y+=12; }
  if(b.phase==="select"){ const menu=["ã„ã‚„ã™","ãŠã¾ã˜ãªã„","ã¼ã†ãã‚‡","ã©ã†ã"]; const cols=2,w=120,hgt=18; let mx=320-8-cols*w-8,my=240-8-2*hgt-8; drawPanel(mx,my,cols*w+8,2*hgt+8);
    for(let i=0;i<menu.length;i++){ const cx=mx+4+(i%cols)*w, cy=my+4+Math.floor(i/cols)*hgt; const sel=(b.sel||0)===i; ctx.fillStyle=sel?"rgba(255,122,214,.25)":"transparent"; ctx.fillRect(cx,cy,w,hgt); drawText(menu[i],cx+4,cy+4,sel?"#ffd6f2":"#fff"); }
  } else if(b.phase==="omajinai"){ drawPanel(20,56,280,120); drawText("ã€ŠãŠã¾ã˜ãªã„ã€‹ â†‘â†“ã§é¸æŠ / OKã§å®Ÿè¡Œ / æˆ»ã‚‹ã§æˆ»ã‚‹",28,60,"#fff");
    const list=["ã‚‚ãˆã‚‚ãˆãã‚…ãƒ¼ (MP5)","ãŠã„ã—ããªãƒ¼ã‚Œ (MP10)"];
    for(let i=0;i<list.length;i++){ const y2=78+i*14, sel=(b.omSel||0)===i; if(sel){ ctx.fillStyle="rgba(255,122,214,.22)"; ctx.fillRect(24,y2-2,272,14); } drawText(list[i],32,y2, sel?"#ffe6f7":"#fff"); }
  } else if(b.phase==="item") drawItemMenu();
  else if(b.phase==="inter") drawText("ã‚¿ãƒ¼ãƒ³çµ‚äº†ã€‚æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸ï¼ˆOKï¼‰",16,212,"#a4b0ff");
}

function drawItemMenu(){ const h=state.hero; const list=h.invI.filter(it=>it.qty>0); drawPanel(20,56,280,120); drawText("ã€Šã©ã†ãã€‹ â†‘â†“ã§é¸æŠ / OKã§ä½¿ç”¨ / æˆ»ã‚‹ã§æˆ»ã‚‹",28,60,"#fff"); if(list.length===0){ drawText("ã¾ã ä½•ã‚‚æŒã£ã¦ã„ãªã„â€¦",28,76,"#ddd"); return; } for(let i=0;i<list.length;i++){ const y=78+i*14, sel=(state.battle.itemSel||0)===i; if(sel){ ctx.fillStyle="rgba(122,225,255,.22)"; ctx.fillRect(24,y-2,272,14); } const base=ITEMS.find(x=>x.id===list[i].id); const label = `${base.name} Ã—${list[i].qty}`; drawText(label,32,y, sel?"#e7faff":"#fff"); } }

// ---------- Fog of War ----------
function reveal(x,y,r=3){
  for(let j=-r;j<=r;j++){
    for(let i=-r;i<=r;i++){
      const nx=x+i, ny=y+j;
      if(nx<0||ny<0||nx>=20||ny>=15) continue;
      const dist = Math.abs(i)+Math.abs(j);
      if(dist<=r) state.visited[ny][nx]=true;
    }
  }
}
function drawFog(){
  for(let j=0;j<15;j++){
    for(let i=0;i<20;i++){
      if(!state.visited[j][i]){
        ctx.fillStyle="rgba(0,0,0,0.90)";
        ctx.fillRect(i*16,j*16,16,16);
      }
    }
  }
}

// ---------- FX ----------
function addPopup(x,y,text,color="#fff",size=12,up=20,stay=400,fade=200){
  if(state.popups.length>=state.maxPopups) state.popups.shift();
  state.popups.push({x,y,text,color,size,vy:-up/stay,life:stay+fade,stay,fade});
}
function drawPopups(){
  const arr=state.popups;
  for(let i=arr.length-1;i>=0;i--){
    const p=arr[i]; const total=p.stay+p.fade; const gone = total - p.life;
    let alpha=1; if(gone>p.stay) alpha=Math.max(0,1-(gone-p.stay)/p.fade);
    const yy = p.y - (gone * (-p.vy));
    ctx.globalAlpha=alpha; drawText(p.text, p.x, yy, p.color, `bold ${p.size}px monospace`); ctx.globalAlpha=1;
    p.life--; if(p.life<=0) arr.splice(i,1);
  }
}
function startShake(mag=6, dur=120, decay=0.8){
  state.shakeMag=mag; state.shakeDur=dur; state.shakeT=dur; state.shakeDecay=decay;
}

// ---------- Input & Loop ----------
const keys={}; document.addEventListener('keydown',e=>{ keys[e.code]=true; if(e.code==="Space") e.preventDefault(); if(state.mode==="title" && (e.code==="Enter"||e.code==="Space")) startNameEntry(); });
document.addEventListener('keyup',e=>{ delete keys[e.code]; });
let last=0,acc=0; function loop(ts){ const dt=(ts-last)/1000; last=ts; acc+=dt; while(acc>1/60){ update(1/60); acc-=1/60; } draw(); requestAnimationFrame(loop); } requestAnimationFrame(loop);
let moveCooldown=0, actionCooldown=0; function pressed(a){ return a.some(k=>keys[k]); }

let prevMode="title";
function update(dt){
  if(state.mode==='title') return titleUpdate(dt);

  // ãƒ¢ãƒ¼ãƒ‰å¤‰åŒ–æ¤œçŸ¥ â†’ BGMåˆ‡ã‚Šæ›¿ãˆ
  if(prevMode!==state.mode){
    if(state.mode==='field' || state.mode==='equip' || state.mode==='dialog'){
      bgmStart('field');
    }else if(state.mode==='battle'){
      // æˆ¦é—˜ä¸­ã§ã‚‚ startBattle æ™‚ã«ãƒœã‚¹/é€šå¸¸ã‚’æ˜ç¤ºã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯ä¿æŒ
    }else{
      bgmStop();
    }
    prevMode=state.mode;
  }

  if(state.mode==='dialog'){
    if(pressed(["Enter","Space"]) && actionCooldown<=0){
      actionCooldown=0.18; state.dialogQueue.shift(); if(state.dialogQueue.length===0) state.mode='field';
    }
  }
  else if(state.mode==='battle') battleUpdate(dt);
  else if(state.mode==='equip') equipUpdate(dt);
  else fieldUpdate(dt);

  moveCooldown=Math.max(0,moveCooldown-dt); actionCooldown=Math.max(0,actionCooldown-dt);
  if(state.shakeT>0){ state.shakeT -= dt*1000; if(state.shakeT<0) state.shakeT=0; }
}

function titleUpdate(dt){
  state.title.blink+=dt; if(state.title.blink>=0.6){ state.title.blink=0; state.title.show=!state.title.show; }
}

// åå‰å…¥åŠ›ï¼ˆiPhoneå‘ã‘ã« prompt æ¡ç”¨ï¼‰
function startNameEntry(){
  armAudio();
  const ask=() => {
    const v = prompt("ãŠåå‰ã‚’æ±ºã‚ã¦ãã ã•ã„ï¼ˆ12æ–‡å­—ã¾ã§ï¼‰","");
    if(v===null) return false;
    const name=(v||"").trim().slice(0,12);
    if(!name){ alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return ask(); }
    state.hero.name=name; state.playerName=name; return true;
  };
  if(ask()){
    // åˆå›ã®å¯è¦–åŒ–
    reveal(state.x, state.y, 3);
    prevMode='title';
    state.mode='field';
    bgmStart('field');
  }
}

// ---------- Field ----------
function fieldUpdate(dt){
  const dx=(keys["ArrowRight"]||keys["KeyD"])?1:(keys["ArrowLeft"]||keys["KeyA"])?-1:0;
  const dy=(keys["ArrowDown"]||keys["KeyS"])?1:(keys["ArrowUp"]||keys["KeyW"])?-1:0;
  if(moveCooldown<=0 && (dx||dy)){
    const nx=Math.max(0,Math.min(19,state.x+dx)), ny=Math.max(0,Math.min(14,state.y+dy));
    let t=MAP[ny][nx];
    if(t!==1){
      state.x=nx; state.y=ny; moveCooldown=0.12;
      if(dx>0) state.facing=1; else if(dx<0) state.facing=3; else if(dy<0) state.facing=0; else if(dy>0) state.facing=2;

      // ãƒ•ã‚©ã‚°æ›´æ–°
      reveal(state.x, state.y, 3);

      // ãƒ©ãƒ³ãƒ€ãƒ ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆï¼ˆé€šè·¯ã®ã¿ï¼‰
      if(t===0 && Math.random()<0.12) startBattle(copyEnemy(ENEMIES[Math.floor(Math.random()*ENEMIES.length)]));

      if(t===2){ state.mode='dialog'; state.dialogQueue=["é‡åšãªæ‰‰ãŒã‚†ã£ãã‚Šã¨é–‹ã„ãŸâ€¦","å¤§åºƒé–“ã‹ã‚‰æ°—é…ã‚’æ„Ÿã˜ã‚‹ã€‚"]; }

      // ãƒœã‚¹æ¥è§¦ã¯å¿…ãšæˆ¦é—˜ã¸
      if(t===6 && state.bossAlive){
        state.mode='dialog';
        state.dialogQueue=[ `${BOSS.name}ï¼šã€Œã“ã“ã¾ã§æ¥ãŸã‹ã€‚å±‹æ•·ã®ä½œæ³•ã€è¦‹ã›ã¦ã¿ã‚ï¼ã€`, "â€”â€” æˆ¦é—˜é–‹å§‹ â€”â€”" ];
        queueAfterDialog(()=>startBattle(copyEnemy(BOSS)));
      }

      if(t===3){
        const key=nx+","+ny;
        if(!state.openedChests[key]){
          const loot=CHEST_LOOT[key];
          if(loot){ giveLoot(loot); state.openedChests[key]=true; seq([{f:880,ms:60,type:'square',vol:0.5},{f:1320,ms:60,type:'square',vol:0.5}]); }
          else state.openedChests[key]=true;
          state.mode='dialog'; const got = loot ? loot.item.name : "ãªã«ã‹"; state.dialogQueue=[`å®ç®±ã‚’ã‚ã‘ãŸï¼`,`ã€Œ${got}ã€ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`];
          // ãƒ¬ã‚¢ 1/500ï¼ˆé‡è¤‡ç„¡ã—ï¼‰
          try{
            if(Math.random()<1/500){
              const u=state.hero.invU;
              if(!u.some(x=>x.id==="body_replica6")){
                const rare=UNIFORMS.find(v=>v.id==="body_replica6");
                if(rare){ u.push(rare); state.dialogQueue.push(`ã•ã‚‰ã«ã€Œ${rare.name}ã€ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`); }
              }
            }
          }catch(e){}
        }
      }
    }
  }
  if(keys["KeyE"] && actionCooldown<=0){ actionCooldown=0.2; openEquip(); }
}

function queueAfterDialog(fn){
  const orig=state.dialogQueue.shift.bind(state.dialogQueue);
  state.dialogQueue.shift=function(){
    const v=Array.prototype.shift.apply(this,arguments);
    if(this.length===0){ state.dialogQueue.shift=orig; fn(); }
    return v;
  }
}
function copyEnemy(t){ return JSON.parse(JSON.stringify(t)); }
function hasItem(list, id){ return list.some(i=>i.id===id); }
function giveLoot(loot){ const h=state.hero; if(loot.type==="weapon"){ if(!hasItem(h.invW, loot.item.id)) h.invW.push(loot.item); } else { if(!hasItem(h.invU, loot.item.id)) h.invU.push(loot.item); } }

// ---------- Battle ----------
function startBattle(enemy){
  state.battle={enemy,phase:'select',log:[`ã€Œ${enemy.name}ã€ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼`],sel:0,turn:1,itemSel:0,defending:false,omSel:0};
  // æˆ¦é—˜BGMã‚’æ˜ç¤ºåˆ‡æ›¿ï¼ˆé€šå¸¸/ãƒœã‚¹ï¼‰
  bgmStart(enemy.boss ? 'boss' : 'battle');
  state.mode='battle';
}
function battleUpdate(dt){
  const b=state.battle,h=state.hero,e=b.enemy;
  if(b.phase==='select'){
    if(keys["ArrowLeft"]&&b.sel%2===1) b.sel--;
    if(keys["ArrowRight"]&&b.sel%2===0) b.sel++;
    if(keys["ArrowUp"]&&b.sel>1) b.sel-=2;
    if(keys["ArrowDown"]&&b.sel<2) b.sel+=2;
    if((keys["Enter"]||keys["Space"]) && actionCooldown<=0){
      actionCooldown=0.18;
      if(b.sel===0){
        const atk=h.atk+(h.weapon?h.weapon.atk:0); const dmg=Math.max(1, atk - e.def + Math.floor(Math.random()*3));
        e.hp-=dmg; b.log.push(`${h.name}ã®ã„ã‚„ã—ã®ä¸€æ’ƒï¼ ${e.name}ã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
        addPopup(200,74, String(dmg), "#ffffff", 12, 20, 400, 200);
        seq([{f:320,ms:70,type:'square',vol:0.5},{f:220,ms:70,type:'square',vol:0.5}]);
        if(e.hp<=0) return winBattle(); enemyAct();
      }else if(b.sel===1){
        b.phase='omajinai'; b.omSel=0;
      }else if(b.sel===2){
        b.defending=true; b.log.push("èº«ã‚’ã‹ãŸã‚ãŸï¼ æ¬¡ã®æ”»æ’ƒã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’æ¸›å°‘");
        enemyAct();
      }else if(b.sel===3){
        b.phase='item'; b.itemSel=0;
      }
    }
  }else if(b.phase==='omajinai'){
    if(keys["ArrowUp"] && b.omSel>0) b.omSel--;
    if(keys["ArrowDown"] && b.omSel<1) b.omSel++;
    if(keys["Escape"]||keys["KeyX"]) b.phase='select';
    if((keys["Enter"]||keys["Space"]) && actionCooldown<=0){
      actionCooldown=0.18;
      if(b.omSel===0){
        if(h.mp>=5){ h.mp-=5; e.hp-=20; b.log.push("ãŠã¾ã˜ãªã„ã€ã‚‚ãˆã‚‚ãˆãã‚…ãƒ¼ã€ï¼ 20ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼");
          addPopup(200,74, "20", "#ffffff", 12, 20, 400, 200);
          seq([{f:660,ms:80,type:'square',vol:0.5},{f:990,ms:80,type:'square',vol:0.5}]);
          if(e.hp<=0) return winBattle(); enemyAct(); }
        else b.log.push("MPãŒãŸã‚Šãªã„â€¦");
      }else{
        if(h.mp>=10){ h.mp-=10; const gain=h.maxhp-h.hp; h.hp=h.maxhp; b.log.push(`ãŠã¾ã˜ãªã„ã€ãŠã„ã—ããªãƒ¼ã‚Œã€ï¼ HPãŒ${gain}å›å¾©ã—ã¦å…¨å¿«ï¼`);
          if(gain>0) addPopup(96,74, "+"+gain, "#66e0ff", 12, 14, 350, 200);
          seq([{f:523,ms:300,type:'sine',vol:0.5,wait:0},{f:659,ms:300,type:'sine',vol:0.5,wait:0},{f:784,ms:300,type:'sine',vol:0.5,wait:0}]);
          enemyAct(); }
        else b.log.push("MPãŒãŸã‚Šãªã„â€¦");
      }
    }
  }else if(b.phase==='item'){
    const list=h.invI.filter(it=>it.qty>0);
    if(keys["ArrowUp"] && b.itemSel>0) b.itemSel--;
    if(keys["ArrowDown"] && b.itemSel<Math.max(0,list.length-1)) b.itemSel++;
    if(keys["Escape"]||keys["KeyX"]) b.phase='select';
    if((keys["Enter"]||keys["Space"]) && actionCooldown<=0){
      actionCooldown=0.18;
      if(list.length===0){ b.log.push("ã¾ã ä½•ã‚‚æŒã£ã¦ã„ãªã„â€¦"); b.phase='select'; return; }
      const stack=list[b.itemSel]; const base=ITEMS.find(x=>x.id===stack.id);
      if(!base){ b.phase='select'; return; }
      useItem(base, stack, b, h, e);
    }
  }else if(b.phase==='inter'){
    if((keys["Enter"]||keys["Space"]) && actionCooldown<=0){ actionCooldown=0.18; b.phase='select'; b.sel=0; b.turn++; }
  }
}

function useItem(base, stack, b, h, e){
  let msg="";
  if(base.kind==="healHP"){
    const before=h.hp; h.hp=Math.min(h.maxhp, h.hp+base.power);
    const g=h.hp-before; msg=`${base.name}ã‚’é£Ÿã¹ãŸï¼ HPãŒ${g}å›å¾©ï¼`; if(g>0) addPopup(96,74,"+"+g,"#66e0ff",12,14,350,200);
  }else if(base.kind==="healMP"){
    const before=h.mp; h.mp=Math.min(h.maxmp, h.mp+base.power);
    const g=h.mp-before; msg=`${base.name}ã‚’é£²ã‚“ã ï¼ MPãŒ${g}å›å¾©ï¼`; if(g>0) addPopup(96,90,"+"+g,"#5aa3ff",12,14,350,200);
  }else if(base.kind==="insta"){
    e.hp=0; msg=`${base.name}ã‚’å¬å–šã—ãŸï¼ ${e.name}ã¯ã¿ã‚‹ã¿ã‚‹ã†ã¡ã«å€’ã‚ŒãŸï¼`; addPopup(200,74,"æ’ƒç ´ï¼","#ffd700",16,20,400,200);
  }
  stack.qty=Math.max(0, stack.qty-1);
  const inMain = state.hero.invI.find(s=>s.id===stack.id); if(inMain) inMain.qty=stack.qty;
  b.log.push(msg);
  if(e.hp<=0){ return winBattle(); }
  enemyAct();
}

function enemyAttackMessage(name, dmg){
  if(name==="æ®‹æ¥­ã‹ã¤å±è²¬ã•ã‚ŒãŸã”ä¸»äººæ§˜") return `ã”ä¸»äººæ§˜ã‹ã‚‰å±è²¬ã•ã‚Œã¤ã¤æ®‹æ¥­ã¨è¨€ã‚ã‚ŒãŸæ™‚ã®æ°—æŒã¡ãŒä¼ã‚ã‚‹ï¼ï¼${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã†ã‘ãŸï¼`;
  if(name==="å®šæ™‚ã®ã”ä¸»äººæ§˜") return `ã”ä¸»äººæ§˜ã‹ã‚‰æ˜æ—¥ã‚‚ä»•äº‹ã‹ã®æ°—æŒã¡ãŒä¼ã‚ã‚‹ï¼ï¼${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã†ã‘ãŸï¼`;
  if(name==="æ®‹æ¥­ã®ã”ä¸»äººæ§˜") return `ã”ä¸»äººæ§˜ã‹ã‚‰æ®‹æ¥­ã¨è¨€ã‚ã‚ŒãŸæ™‚ã®æ°—æŒã¡ãŒä¼ã‚ã‚‹ï¼ï¼${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã†ã‘ãŸï¼`;
  if(name==="å±è²¬ã‚’å—ã‘ãŸã”ä¸»äººæ§˜" || name==="å±è²¬ã•ã‚ŒãŸã”ä¸»äººæ§˜") return `ã”ä¸»äººæ§˜ã‹ã‚‰å±è²¬ã•ã‚ŒãŸæ™‚ã®æ°—æŒã¡ãŒä¼ã‚ã‚‹ï¼ï¼${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã†ã‘ãŸï¼`;
  return `${name}ã®ã“ã†ã’ãï¼ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
}

function enemyAct(){ const b=state.battle,h=state.hero,e=b.enemy; const def=totalDef(h);
  let dmg=Math.max(1, e.atk - def + Math.floor(Math.random()*3));
  if(b.defending){ dmg=Math.floor(dmg/2); b.defending=false; }
  h.hp-=dmg; addPopup(96,74,"-"+dmg,"#ff5555",12,16,350,200); startShake(6,120,0.8); seq([{f:180,ms:120,type:'sine',vol:0.5}]);
  b.log.push(enemyAttackMessage(e.name, dmg));
  if(h.hp<=0){ b.log.push(`${h.name}ã¯å€’ã‚Œã¦ã—ã¾ã£ãŸâ€¦`); setTimeout(()=>gameOver(),500); } else b.phase='inter';
}

function winBattle(){ const b=state.battle,h=state.hero,e=b.enemy; b.log.push(`${e.name}ã‚’ãŸãŠã—ãŸï¼`); seq([{f:523,ms:120,type:'sine',vol:0.5},{f:659,ms:120,type:'sine',vol:0.5},{f:784,ms:120,type:'sine',vol:0.5}]); h.exp+=e.exp;
  const needNextBefore = h.lv*22 - h.exp; b.log.push(`EXP+${e.exp} / æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§ ${Math.max(0,needNextBefore)}`);
  const need=h.lv*22; if(h.exp>=need){ h.exp-=need; h.lv++; h.maxhp+=6; h.maxmp+=2; h.atk+=2; h.def+=1; h.hp=h.maxhp; h.mp=h.maxmp; b.log.push(`ãƒ¬ãƒ™ãƒ«ãŒ${h.lv}ã«ãªã£ãŸï¼`); }
  if(!e.boss && Math.random()<0.30){
    const id = (Math.random()<0.5) ? "omurice" : "tea";
    const base = ITEMS.find(x=>x.id===id);
    const stack = h.invI.find(s=>s.id===id);
    if(stack) stack.qty += 1; else h.invI.push({id, qty:1});
    b.log.push(`ã€Œ${base.name}ã€ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`);
  }
  if(e.boss){ state.bossAlive=false; setTimeout(()=>{ state.mode='dialog'; state.dialogQueue=[ `${BOSS.name}ï¼šã€Œè¦‹äº‹ã ã€‚å›ã¯çœŸã®ãƒ¡ã‚¤ãƒ‰ã ï¼ã€`, " â€”â€” ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã† ğŸ‰ â€”â€” " ]; endBattle(true); },500); }
  else setTimeout(()=>endBattle(true),300);
}

function endBattle(v){ state.mode='field'; state.battle=null; bgmStart('field'); }
function gameOver(){ state.mode='dialog'; state.dialogQueue=['ç›®ã®å‰ãŒçœŸã£é»’ã«ãªã£ãŸâ€¦','ç„é–¢ãƒ›ãƒ¼ãƒ«ã‹ã‚‰å‡ºç›´ãã†ã€‚']; const lastName = state.hero && state.hero.name ? state.hero.name : (state.playerName||null); state.hero=JSON.parse(JSON.stringify(heroBase)); if(lastName){ state.hero.name = lastName; state.playerName = lastName; } state.x=1; state.y=1; state.battle=null; reveal(state.x,state.y,3); bgmStart('field'); }

// ---------- Equip ----------
let equipState={cat:0, sel:0, fromBattle:false};
function openEquip(fromBattle=false){ equipState={cat:0,sel:0,fromBattle}; state.mode='equip'; }
function equipList(cat,h){ if(cat===0) return h.invW; if(cat===1) return h.invU.filter(i=>i.slot==='legs'); if(cat===2) return h.invU.filter(i=>i.slot==='body'); return h.invU.filter(i=>i.slot==='head'); }
function equipUpdate(dt){ const h=state.hero, list=equipList(equipState.cat,h); if(keys["ArrowLeft"]||keys["KeyQ"]) equipState.cat=(equipState.cat+3)%4; if(keys["ArrowRight"]||keys["KeyE"]) equipState.cat=(equipState.cat+1)%4; if(keys["ArrowUp"] && equipState.sel>0) equipState.sel--; if(keys["ArrowDown"] && equipState.sel<list.length-1) equipState.sel++; if((keys["Enter"]||keys["Space"])){ const it=list[equipState.sel]; if(it) equipItem(h,it); closeEquip(true); } if(keys["Escape"]||keys["KeyX"]) closeEquip(false); }
function equipItem(h,it){ if(it.atk) h.weapon=it; else if(it.slot==='legs') h.u_legs=it; else if(it.slot==='body') h.u_body=it; else h.u_head=it; }
function drawEquip(){ const h=state.hero; drawPanel(8,16,304,208); drawText("ã€Šè£…å‚™ã€‹",16,20,"#fff"); drawText(`æ­¦å™¨: ${h.weapon?h.weapon.name:"(ãªã—)"}`,16,36,"#ffd6f2"); drawText(`è„š:   ${h.u_legs?h.u_legs.name:"(ãªã—)"}`,16,48,"#a4ffea"); drawText(`èƒ´:   ${h.u_body?h.u_body.name:"(ãªã—)"}`,16,60,"#a4ffea"); drawText(`é ­:   ${h.u_head?h.u_head.name:"(ãªã—)"}`,16,72,"#a4ffea"); drawText("â†â†’ã‚«ãƒ†ã‚´ãƒª / â†‘â†“é¸æŠ / æ±ºå®šã§è£…å‚™ / æˆ»ã‚‹ã§é–‰ã˜ã‚‹",16,88,"#ddd"); const title=["æ­¦å™¨","è„šï¼ˆã‚¹ãƒˆãƒƒã‚­ãƒ³ã‚°ï¼‰","èƒ´ï¼ˆã‚¨ãƒ—ãƒ­ãƒ³ï¼‰","é ­ï¼ˆã‚«ãƒãƒ¥ãƒ¼ã‚·ãƒ£ï¼‰"][equipState.cat]; drawText("ã‚«ãƒ†ã‚´ãƒª: "+title,16,104,"#fff"); const list=equipList(equipState.cat,h); for(let i=0;i<list.length;i++){ const y=120+i*14, sel=i===equipState.sel; if(sel){ctx.fillStyle="rgba(122,225,255,.22)"; ctx.fillRect(12,y-2,296,14);} const it=list[i]; drawText(`${it.name} ${it.atk?`(+ATK ${it.atk})`:`(+DEF ${it.def})`}`,20,y, sel?"#e7faff":"#fff"); } }
function closeEquip(used){ if(state.mode!=='equip') return; if(state.battle){ state.mode='battle'; if(used){ state.battle.log.push("è£…å‚™ã‚’ã¨ã¨ã®ãˆãŸï¼"); enemyAct(); } } else state.mode='field'; }

// ---------- Buttons ----------
document.getElementById('btnReset').onclick=()=>{ if(confirm("æœ€åˆã‹ã‚‰ã¯ã˜ã‚ã¾ã™ã‹ï¼Ÿ")){ bgmStop(); state={ hero:JSON.parse(JSON.stringify(heroBase)), x:1,y:1,facing:2, mode:"title", dialogQueue:[], battle:null, bossAlive:true, openedChests:{}, title:{blink:0,show:true}, nameMode:false, playerName:state.playerName, popups:[], shakeT:0, visited:Array.from({length:15},()=>Array(20).fill(false)) }; prevMode='title'; } };
document.getElementById('btnMute').onclick=(e)=>{ mute=!mute; e.target.textContent="åŠ¹æœéŸ³: "+(mute?"OFF":"ON"); if(mute) bgmStop(); else{ if(state.mode==='field' || state.mode==='equip' || state.mode==='dialog') bgmStart('field'); else if(state.mode==='battle'){ const boss = state.battle?.enemy?.boss; bgmStart(boss ? 'boss' : 'battle'); } } };
document.getElementById('btnFull').onclick=()=>{ const el=document.getElementById('game'); if(!document.fullscreenElement){ el.requestFullscreen && el.requestFullscreen(); } else { document.exitFullscreen && document.exitFullscreen(); } };
document.getElementById('btnEquip').onclick=()=>openEquip(false);
document.getElementById('btnStart').onclick=()=>{ if(state.mode==='title') startNameEntry(); };
document.getElementById('btnActEquip').onclick=()=>openEquip(false);

// ---------- On-screen controls â†’ key emulation ----------
function press(code, duration=120){
  keys[code]=true;
  setTimeout(()=>{ delete keys[code]; }, duration);
}
function bindPad(){
  document.querySelectorAll('.btnc').forEach(b=>{
    const code=b.getAttribute('data-k');
    let tid=null;
    const start=()=>{ press(code); tid=setInterval(()=>press(code), 150); };
    const end=()=>{ if(tid){ clearInterval(tid); tid=null; delete keys[code]; } };
    b.addEventListener('touchstart', e=>{ e.preventDefault(); start(); }, {passive:false});
    b.addEventListener('mousedown', e=>{ e.preventDefault(); start(); });
    ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=> b.addEventListener(ev, end, {passive:true}));
  });
  document.querySelectorAll('.btnL').forEach(b=>{
    let main=b.getAttribute('data-k'); let alt=b.getAttribute('data-alt');
    b.addEventListener('click', e=>{ e.preventDefault(); press(main); if(alt) setTimeout(()=>press(alt), 10); });
  });
}
bindPad();

// Tap to advance dialogs/title
cvs.addEventListener('click',()=>{ if(state.mode==='title'){ startNameEntry(); return; } if(state.mode==='dialog'){ press('Enter'); } });

// iOS audio unlock on first touch
function armAudio(){ try{ const c=(window.AudioContext||window.webkitAudioContext)?audio():null; if(c&&c.state==='suspended'&&c.resume) c.resume(); }catch(_ ){} }
['pointerdown','touchstart'].forEach(ev=>{ document.addEventListener(ev, ()=>armAudio(), {once:true, passive:true}); });

// Title blink
setInterval(()=>{ if(state.mode==='title') state.title.show=!state.title.show; }, 600);
</script>
</body>
</html>
